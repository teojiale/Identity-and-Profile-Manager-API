<!-- base.html -->
<!DOCTYPE html>
<html class="h-full bg-white">
    <head>
        {% load static %}
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{% block title %}Identity & Profile Manager{% endblock %}</title>
        <link rel="stylesheet" href="{% static 'css/styles.css' %}">
        {% block extra_head %}{% endblock %}
    </head>
    <body class="h-full">
        <!-- Header/Navbar -->
        <header class="absolute inset-x-0 top-0 z-40 flex h-16 border-b border-gray-900/10">
            <div class="mx-auto flex w-full max-w-7xl items-center justify-between px-4 sm:px-6 lg:px-8">
              <div class="flex flex-1 items-center gap-x-6">
                <a href="/" class="h-8 w-auto">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-8 stroke-indigo-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M7.864 4.243A7.5 7.5 0 0 1 19.5 10.5c0 2.92-.556 5.709-1.568 8.268M5.742 6.364A7.465 7.465 0 0 0 4.5 10.5a7.464 7.464 0 0 1-1.15 3.993m1.989 3.559A11.209 11.209 0 0 0 8.25 10.5a3.75 3.75 0 1 1 7.5 0c0 .527-.021 1.049-.064 1.565M12 10.5a14.94 14.94 0 0 1-3.6 9.75m6.633-4.596a18.666 18.666 0 0 1-2.485 5.33" />
                </svg>

                </a>
              </div>
              
              <div class="flex flex-1 items-center justify-end gap-x-4 sm:gap-x-8">
                {% if user.is_authenticated %}
                <button id="open-cmd" type="button" aria-label="Search" class="flex items-center gap-1 rounded-full bg-gray-950/2 px-2 py-1 inset-ring inset-ring-gray-950/8 dark:bg-white/2 dark:inset-ring-white/8">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" data-slot="icon" class="-ml-0.5 size-4 fill-gray-600 dark:fill-gray-400">
                    <path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd"></path>
                  </svg>
                  <kbd class="font-sans text-xs/4 text-gray-500 not-in-[.macos]:after:content-['Ctrl_K'] in-[.macos]:after:content-['⌘K']"></kbd>
                </button>
                  <div class="flex items-center gap-x-4">
                        
                    <div class="relative inline-block text-left">
                      <div>
                        <button type="button" class="inline-flex w-full justify-center gap-x-1.5 text-sm font-semibold text-gray-900 shadow-xs rounded-full focus:ring-indigo-600 focus:ring-2 focus:ring-offset-2" id="menu-button" aria-expanded="true" aria-haspopup="true -m-1.5 p-1.5">
                      <span class="sr-only">Your profile</span>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"  class="size-8 rounded-full flex-none ring-1 ring-gray-900/10 p-2 fill-white bg-indigo-600">
            <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd" />
          </svg>
                        </button>
                      </div>
                    

                      <div class="absolute right-0 z-10 mt-2 w-56 origin-top-right divide-y divide-gray-100 rounded-md bg-white ring-1 shadow-lg ring-black/5 focus:outline-hidden" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                        <div class="px-4 py-3" role="none">
                          <p class="text-xs/4" role="none">Signed in as</p>
                          <p class="truncate text-base font-bold text-gray-900" role="none">{{ user.username }}</p>
                        </div>
                        <div class="py-1" role="none">
                          <!-- Active: "bg-gray-100 text-gray-900 outline-hidden", Not Active: "text-gray-700" -->
                          <a href="{% url 'profile_detail' user.username %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 hover:outline-hidden" role="menuitem" tabindex="-1" id="menu-item-0">My Profile</a>
                          <a href="{% url 'profile_edit' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 hover:outline-hidden" role="menuitem" tabindex="-1" id="menu-item-1">Edit Profile</a>
                        </div>
                        <div class="py-1" role="none">
                            <a href="{% url 'logout' %}" type="submit" class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 hover:outline-hidden" role="menuitem" tabindex="-1" id="menu-item-3">Sign out</a>
                        </div>
                      </div>
                    </div>
                  
                  </div>
                {% else %}
                  <a href="{% url 'login_page' %}" class="inline-block rounded-lg px-2 py-1 text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900">Login</a>
                  <a class="group inline-flex items-center justify-center rounded-lg py-2 px-4 text-sm font-semibold focus-visible:outline-2 focus-visible:outline-offset-2 bg-indigo-600 text-white hover:text-slate-100 hover:bg-indigo-500 active:bg-indigo-800 active:text-indigo-100 focus-visible:outline-indigo-600 whitespace-nowrap" href="{% url 'register' %}"><span>Get started <span class="hidden lg:inline">today</span></span></a>
                {% endif %}
              </div>
            </div>
            
          </header>

        <!-- Main content area -->
        <main class="{% block main_classes %}{% endblock %}">
            {% block content %}{% endblock %}
        </main>

        <!-- Footer -->
        {% block footer %}{% endblock %}

        <!-- Scripts -->
        {% block scripts %}{% endblock %}

<form id="csrf-form" style="display: none;">{% csrf_token %}</form>

    <div id="command-palette" class="relative z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="command-palette-title">
      <div id="backdrop" class="fixed inset-0 bg-gray-500/25 transition-opacity" aria-hidden="true"></div>

      <div id="overlay" class="fixed inset-0 z-50 w-screen overflow-y-auto p-4 sm:p-6 md:p-20">
        <div class="modal-card mx-auto max-w-xl transform divide-y divide-gray-100 overflow-hidden rounded-xl bg-white ring-1 shadow-2xl ring-black/5 transition-all">
          <div class="grid grid-cols-1">
            <input id="cmd-input" type="text" class="col-start-1 row-start-1 h-12 w-full pr-4 pl-11 text-base text-gray-900 outline-hidden placeholder:text-gray-400 sm:text-sm" placeholder="Search for a person..." role="combobox" aria-expanded="false" aria-controls="options" autocomplete="off" />
            <svg class="pointer-events-none col-start-1 row-start-1 ml-4 size-5 self-center text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon">
              <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" />
            </svg>
          </div>

          <ul class="max-h-72 scroll-py-2 overflow-y-auto py-2 text-sm text-gray-800 hidden" id="options" role="listbox"></ul>
          <p id="empty-state" class="p-4 text-sm text-gray-500 hidden"></p>
          <p id="error-state" class="p-4 text-sm text-red-600 hidden"></p>
        </div>
      </div>
    </div>
    <script>
      (function() {
        const openBtn = document.getElementById('open-cmd');
        const modal = document.getElementById('command-palette');
        const backdrop = document.getElementById('backdrop');
        const input = document.getElementById('cmd-input');
        const overlay = document.getElementById('overlay');
        const list = document.getElementById('options');
        const emptyState = document.getElementById('empty-state');
        const errorState = document.getElementById('error-state');

        let isOpen = false;
        let debounceTimer = null;
        let selectedIndex = -1;
        let currentResults = [];

        function onKeyDownCapture(e) {
          if (e.key === 'Escape' && isOpen) {
            e.preventDefault();
            e.stopPropagation();
            closeModal();
          }
        }

        function updateActiveItem() {
          const items = list.children;
          for (let i = 0; i < items.length; i++) {
            const link = items[i].querySelector('a');
            if (!link) continue;
            if (i === selectedIndex) {
              link.className = 'block w-full px-4 py-2 bg-indigo-600 text-white';
              input.setAttribute('aria-activedescendant', items[i].id);
              items[i].scrollIntoView({ block: 'nearest' });
            } else {
              link.className = 'block w-full px-4 py-2 hover:bg-indigo-600 hover:text-white';
            }
          }
        }

        function moveSelection(delta) {
          if (!Array.isArray(currentResults) || currentResults.length === 0) return;
          selectedIndex = (selectedIndex + delta + currentResults.length) % currentResults.length;
          updateActiveItem();
        }

        function selectActive() {
          if (!Array.isArray(currentResults) || currentResults.length === 0) return;
          if (selectedIndex < 0 || selectedIndex >= list.children.length) return;
          const active = list.children[selectedIndex];
          const link = active && active.querySelector('a');
          if (link && link.href) {
            window.location.href = link.href;
          }
        }

        function openModal() {
          if (isOpen) return;
          isOpen = true;
          modal.classList.remove('hidden');
          requestAnimationFrame(() => input.focus());
          document.addEventListener('keydown', onKeyDown);
          document.addEventListener('keydown', onKeyDownCapture, true);
          input.setAttribute('aria-expanded', 'true');
        }

        function closeModal() {
          if (!isOpen) return;
          isOpen = false;
          modal.classList.add('hidden');
          input.value = '';
          renderResults([]);
          emptyState.textContent = '';
          emptyState.classList.add('hidden');
          errorState.classList.add('hidden');
          document.removeEventListener('keydown', onKeyDown);
          document.removeEventListener('keydown', onKeyDownCapture, true);
          selectedIndex = -1;
          currentResults = [];
          input.setAttribute('aria-expanded', 'false');
        }

        function onKeyDown(e) {
          if (e.key === 'Escape') {
            e.preventDefault();
            closeModal();
            return;
          }
          if (!isOpen) return;
          if (e.key === 'ArrowDown' || (e.key === 'Tab' && !e.shiftKey)) {
            e.preventDefault();
            moveSelection(1);
            return;
          }
          if (e.key === 'ArrowUp' || (e.key === 'Tab' && e.shiftKey)) {
            e.preventDefault();
            moveSelection(-1);
            return;
          }
          if (e.key === 'Enter') {
            // Only act on Enter if we have a selection
            if (Array.isArray(currentResults) && currentResults.length > 0 && selectedIndex >= 0) {
              e.preventDefault();
              selectActive();
            }
          }
        }

        openBtn.addEventListener('click', openModal);
        backdrop.addEventListener('click', closeModal);
        overlay.addEventListener('click', (e) => {
          if (!e.target.closest('.modal-card')) {
            closeModal();
          }
        });

        // Global shortcut: Cmd+K (macOS) / Ctrl+K (Windows/Linux)
        document.addEventListener('keydown', (e) => {
          const isModifierK = (e.metaKey || e.ctrlKey) && (e.key === 'k' || e.key === 'K');
          if (!isModifierK) return;
          // Avoid triggering inside text inputs other than the command input
          const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
          const isTypingField = tag === 'input' || tag === 'textarea' || (e.target && e.target.isContentEditable);
          if (isTypingField && e.target !== input) return;
          e.preventDefault();
          openModal();
        });

        // Ensure Escape closes even if focus is on the input (some browsers stop propagation)
        input.addEventListener('keyup', (e) => {
          if (e.key === 'Escape') {
            e.preventDefault();
            closeModal();
          }
        });

        function renderResults(results) {
          list.innerHTML = '';
          if (!Array.isArray(results) || results.length === 0) {
            list.classList.add('hidden');
            currentResults = [];
            selectedIndex = -1;
            return;
          }
          emptyState.classList.add('hidden');
          list.classList.remove('hidden');
          currentResults = results;
          selectedIndex = 0;
          results.forEach((profile, idx) => {
            const li = document.createElement('li');
            li.className = 'w-full cursor-default select-none';
            li.id = `option-${idx+1}`;
            li.setAttribute('role', 'option');
            li.setAttribute('tabindex', '-1');

            const link = document.createElement('a');
            link.href = `/profile/${encodeURIComponent(profile.username)}/`;
            link.className = idx === selectedIndex
              ? 'block w-full px-4 py-2 bg-indigo-600 text-white'
              : 'block w-full px-4 py-2 hover:bg-indigo-600 hover:text-white';

            const extraInfo = Object.entries(profile)
              .filter(([key]) => key !== 'username')
              .map(([key, val]) => `${key}: ${val}`)
              .join(', ');

            link.textContent = profile.username + (extraInfo ? ' — ' + extraInfo : '');
            li.appendChild(link);
            list.appendChild(li);
          });
          updateActiveItem();
        }

        async function performSearch(query) {
          errorState.classList.add('hidden');
          emptyState.textContent = 'Searching...';
          emptyState.classList.remove('hidden');
          try {
            // Use Django's CSRF token for session-based authentication
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            const response = await fetch(`/IdentityAndProfileManagerAPI/IdentityAndProfileManager/search/?q=${encodeURIComponent(query)}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken || '',
              },
              credentials: 'same-origin', // Include cookies for session authentication
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || 'Search failed');
            }

            if (Array.isArray(data)) {
              if (data.length === 0) {
                emptyState.textContent = 'No people found.';
                emptyState.classList.remove('hidden');
                renderResults([]);
              } else {
                renderResults(data);
              }
            } else {
              // The API may return {error: "No matches found."} with 200
              if (data && data.error) {
                emptyState.textContent = data.error;
                emptyState.classList.remove('hidden');
                renderResults([]);
              } else {
                renderResults([]);
                emptyState.textContent = 'No people found.';
                emptyState.classList.remove('hidden');
              }
            }
          } catch (err) {
            renderResults([]);
            emptyState.classList.add('hidden');
            errorState.textContent = err.message || 'Unexpected error';
            errorState.classList.remove('hidden');
          }
        }

        input.addEventListener('input', (e) => {
          const q = e.target.value.trim();
          if (debounceTimer) clearTimeout(debounceTimer);
          if (q.length === 0) {
            renderResults([]);
            emptyState.textContent = '';
            emptyState.classList.add('hidden');
            errorState.classList.add('hidden');
            return;
          }
          debounceTimer = setTimeout(() => performSearch(q), 300);
        });
      })();

      // Interactive dropdown menu functionality
      (function() {
        const menuButton = document.getElementById('menu-button');
        const dropdownMenu = document.querySelector('[role="menu"]');
        let isDropdownOpen = false;

        // Function to show dropdown
        function showDropdown() {
          if (isDropdownOpen) return;

          isDropdownOpen = true;
          dropdownMenu.classList.remove('hidden');
          dropdownMenu.classList.add('transform', 'opacity-100', 'scale-100');
          menuButton.setAttribute('aria-expanded', 'true');

          // Add transition classes for smooth animation
          setTimeout(() => {
            dropdownMenu.classList.remove('transform', 'opacity-0', 'scale-95');
          }, 10);
        }

        // Function to hide dropdown
        function hideDropdown() {
          if (!isDropdownOpen) return;

          isDropdownOpen = false;
          dropdownMenu.classList.add('transform', 'opacity-0', 'scale-95');
          menuButton.setAttribute('aria-expanded', 'false');

          // Hide after transition
          setTimeout(() => {
            dropdownMenu.classList.add('hidden');
            dropdownMenu.classList.remove('transform', 'opacity-100', 'scale-100');
          }, 75);
        }

        // Toggle dropdown on button click
        menuButton.addEventListener('click', function(e) {
          e.stopPropagation();
          if (isDropdownOpen) {
            hideDropdown();
          } else {
            showDropdown();
          }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (isDropdownOpen && !dropdownMenu.contains(e.target) && !menuButton.contains(e.target)) {
            hideDropdown();
          }
        });

        // Close dropdown on Escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && isDropdownOpen) {
            hideDropdown();
          }
        });

        // Handle menu item clicks
        const menuItems = dropdownMenu.querySelectorAll('[role="menuitem"]');
        menuItems.forEach(item => {
          item.addEventListener('click', function() {
            hideDropdown();
          });
        });

        // Initialize dropdown as hidden with proper classes
        dropdownMenu.classList.add('hidden', 'transform', 'opacity-0', 'scale-95');
      })();
            </script>
            <script>
              if (navigator.platform.toUpperCase().indexOf('MAC') >= 0) {
                document.documentElement.classList.add('macos');
              }
            </script>
    </body>
</html>
