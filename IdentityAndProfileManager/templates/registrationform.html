<!-- registrationform.html -->
<!DOCTYPE html>
<html class="h-full bg-white">
    <head>
        {% load static %}
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sign Up</title>
        <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    </head>
    <body class="h-full">
<div class="flex min-h-full items-center justify-center px-4 py-12 sm:px-6 lg:px-8">
            <div class="w-full max-w-sm space-y-10">
                <div>
                    <a href="/" class="h-10 w-auto flex justify-center">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-10 stroke-indigo-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M7.864 4.243A7.5 7.5 0 0 1 19.5 10.5c0 2.92-.556 5.709-1.568 8.268M5.742 6.364A7.465 7.465 0 0 0 4.5 10.5a7.464 7.464 0 0 1-1.15 3.993m1.989 3.559A11.209 11.209 0 0 0 8.25 10.5a3.75 3.75 0 1 1 7.5 0c0 .527-.021 1.049-.064 1.565M12 10.5a14.94 14.94 0 0 1-3.6 9.75m6.633-4.596a18.666 18.666 0 0 1-2.485 5.33" />
                </svg>
</a>
                    <h2 class="mt-10 text-center text-2xl/9 font-bold tracking-tight text-gray-900">Create your account</h2>
                </div>

                <form class="space-y-6" id="register-form">
                    <div id="step-username">
                        <div id="username-field" class="mt-0 grid grid-cols-1">
                            <input id="username" name="username" type="text" autocomplete="username" required aria-label="Username" aria-invalid="false" aria-describedby="username-error" class="col-start-1 row-start-1 block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:relative focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6" placeholder="Choose a unique username">
                            <svg id="username-error-icon" class="pointer-events-none col-start-1 row-start-1 mr-3 size-5 self-center justify-self-end text-red-500 sm:size-4 hidden" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" data-slot="icon">
                              <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14ZM8 4a.75.75 0 0 1 .75.75v3a.75.75 0 0 1-1.5 0v-3A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <p id="username-error" class="text-xs mt-0.5 text-red-500 select-none text-right hidden"></p>
                        <p id="username-hint" class="mt-2 text-xs text-gray-400 select-none italic">Only letters, numbers, underscores. 3-30 chars.</p>
                        <button id="continue-btn" type="button" class="flex w-full items-center justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm/6 font-semibold text-white hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:hover:bg-indigo-600 disabled:hover:opacity-50 disabled:opacity-50 disabled:cursor-not-allowed mt-4" aria-disabled="true" disabled>Continue</button>
                    </div>

                    <div id="step-credentials" class="hidden">
                        <div>
                            <div class="col-span-2">
                                <input disabled id="username-confirm" name="username-confirm" type="text" autocomplete="username" readonly aria-label="Username" class="block w-full rounded-t-md bg-gray-100 px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:relative focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6  disabled:cursor-text disabled:bg-gray-50 disabled:text-gray-500 disabled:outline-gray-200" placeholder="Username">
                            </div>
                            <div id="password-field" class="grid grid-cols-1 mb-2">
                                <input id="password" name="password" type="password" autocomplete="new-password" required aria-label="Password" aria-invalid="false" aria-describedby="password-error" class="col-start-1 row-start-1 block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:relative focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6" placeholder="Create a password">
                                <svg id="password-error-icon" class="pointer-events-none col-start-1 row-start-1 mr-3 size-5 self-center justify-self-end text-red-500 sm:size-4 hidden" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" data-slot="icon">
                                  <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14ZM8 4a.75.75 0 0 1 .75.75v3a.75.75 0 0 1-1.5 0v-3A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <p id="password-error" class="text-xs mt-0.5 text-red-500 select-none text-right hidden"></p>
                            <p id="password-hint" class="mt-2 text-xs text-gray-400 select-none italic">At least 8 chars, 1 uppercase, 1 lowercase, 1 number. Cannot contain username.</p>
                        </div>

                        <div class="mt-2">
                            <button type="submit" class="flex w-full items-center justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm/6 font-semibold text-white hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Sign up</button>
                        </div>
                    </div>
                </form>

                <p class="text-center text-sm/6 text-gray-500">
                    Already have an account?
                    <a href="{% url 'login_page' %}" class="font-semibold text-indigo-600 hover:text-indigo-500">Log in</a>
                </p>
                <p id="error-msg" class="text-red-600"></p>
            </div>
        </div>
<!-- CSRF token form for AJAX requests -->
<form id="csrf-form" style="display: none;">{% csrf_token %}</form>

<script>
            const form = document.getElementById('register-form');
            const stepUsername = document.getElementById('step-username');
            const stepCredentials = document.getElementById('step-credentials');
            const continueBtn = document.getElementById('continue-btn');
            const signupBtn = form.querySelector('button[type="submit"]');
            const usernameInput = document.getElementById('username');
            const usernameErrorIcon = document.getElementById('username-error-icon');
            const usernameConfirm = document.getElementById('username-confirm');
            const usernameError = document.getElementById('username-error');
            const errorMsg = document.getElementById('error-msg');
            const passwordInput = document.getElementById('password');
            const passwordErrorIcon = document.getElementById('password-error-icon');
            const passwordError = document.getElementById('password-error');

            let lastQuery = '';
            let debounceTimer = null;

            // Global CSRF token function
            function getCSRFToken() {
                const csrfForm = document.getElementById('csrf-form');
                if (csrfForm) {
                    const csrfInput = csrfForm.querySelector('input[name="csrfmiddlewaretoken"]');
                    return csrfInput ? csrfInput.value : null;
                }
                return null;
            }

            // autofocus username on load
            if (usernameInput) {
                usernameInput.focus();
            }

            function validateUsername(u){
                if (u.length === 0) {
                    return { isValid: false, message: 'Username is required.' };
                }

                if (u.length < 3) {
                    return { isValid: false, message: 'Username must be at least 3 characters long.' };
                }

                if (u.length > 30) {
                    return { isValid: false, message: 'Username must be no more than 30 characters long.' };
                }

                if (!/^[A-Za-z0-9_]+$/.test(u)) {
                    return { isValid: false, message: 'Username can only contain letters, numbers, and underscores.' };
                }

                if (!/^[A-Za-z0-9_]*[A-Za-z][A-Za-z0-9_]*$/.test(u) && u.length > 0) {
                    return { isValid: false, message: 'Username must contain at least one letter.' };
                }

                return { isValid: true, message: '' };
            }

            function validUsername(u){
                return validateUsername(u).isValid;
            }

            async function checkAvailability(u){
                try {
                    // Get CSRF token for the request
                    const csrfToken = getCSRFToken();
                    const headers = {};
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }

                    const res = await fetch(`/IdentityAndProfileManagerAPI/check-username/?username=${encodeURIComponent(u)}`, {
                        headers: headers
                    });
                    if(!res.ok){
                        return { available: false };
                    }
                    return await res.json();
                } catch (error) {
                    console.error('Username availability check failed:', error);
                    return { available: false };
                }
            }

            function setUsernameErrorState(message) {
                usernameInput.setAttribute('aria-invalid', 'true');
                usernameInput.className = 'col-start-1 row-start-1 block w-full rounded-md bg-white py-1.5 pr-10 pl-3 text-base text-red-900 outline-1 -outline-offset-1 outline-red-300 placeholder:text-red-300 focus:outline-2 focus:-outline-offset-2 focus:outline-red-600 sm:pr-9 sm:text-sm/6';
                usernameError.textContent = message || '';
                usernameError.classList.toggle('hidden', !message);
                usernameErrorIcon.classList.remove('hidden');
            }

            function clearUsernameErrorState() {
                usernameInput.setAttribute('aria-invalid', 'false');
                usernameInput.className = 'col-start-1 row-start-1 block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:relative focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6';
                usernameError.textContent = '';
                usernameError.classList.add('hidden');
                usernameErrorIcon.classList.add('hidden');
            }

            function setPasswordErrorState(message) {
                passwordInput.setAttribute('aria-invalid', 'true');
                passwordInput.className = 'col-start-1 row-start-1 block w-full rounded-b-md bg-white py-1.5 pr-10 pl-3 text-base text-red-900 outline-1 -outline-offset-1 outline-red-300 placeholder:text-red-300 focus:outline-2 focus:-outline-offset-2 focus:outline-red-600 sm:pr-9 sm:text-sm/6';
                passwordError.textContent = message || '';
                passwordError.classList.toggle('hidden', !message);
                passwordErrorIcon.classList.remove('hidden');
            }

            function clearPasswordErrorState() {
                passwordInput.setAttribute('aria-invalid', 'false');
                passwordInput.className = 'col-start-1 row-start-1 block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:relative focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6';
                passwordError.textContent = '';
                passwordError.classList.add('hidden');
                passwordErrorIcon.classList.add('hidden');
            }



            function validatePassword(password) {
                if (password.length === 0) {
                    return { isValid: false, message: 'Password is required.' };
                }

                if (password.length < 8) {
                    return { isValid: false, message: 'Password must be at least 8 characters long.' };
                }

                if (!/[a-z]/.test(password)) {
                    return { isValid: false, message: 'Password must contain at least one lowercase letter.' };
                }

                if (!/[A-Z]/.test(password)) {
                    return { isValid: false, message: 'Password must contain at least one uppercase letter.' };
                }

                if (!/\d/.test(password)) {
                    return { isValid: false, message: 'Password must contain at least one number.' };
                }

                const weakPasswords = ['password', '12345678', 'qwerty', 'abc123', 'password123', 'admin', 'letmein', 'welcome', '123456789', 'iloveyou'];
                if (weakPasswords.includes(password.toLowerCase())) {
                    return { isValid: false, message: 'This password is too common. Please choose a stronger password.' };
                }

                const username = usernameInput.value.trim().toLowerCase();
                if (username && password.toLowerCase().includes(username)) {
                    return { isValid: false, message: 'Password cannot contain your username.' };
                }

                return { isValid: true, message: '' };
            }

            function updateSignupButton() {
                if (!signupBtn) return;

                const password = passwordInput.value;
                const validation = validatePassword(password);

                if (validation.isValid) {
                    signupBtn.disabled = false;
                    signupBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    signupBtn.disabled = true;
                    signupBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            usernameInput.addEventListener('input', () => {
                const value = usernameInput.value.trim();
                clearUsernameErrorState();
                continueBtn.disabled = true;

                const validation = validateUsername(value);
                if(!validation.isValid){
                    if(value.length > 0){
                        setUsernameErrorState(validation.message);
                    }
                    return;
                }

                if(debounceTimer){ clearTimeout(debounceTimer); }
                debounceTimer = setTimeout(async () => {
                    lastQuery = value;
                    const { available } = await checkAvailability(value);
                    if (lastQuery !== value) return; // stale
                    if(available){
                        continueBtn.disabled = false;
                        clearUsernameErrorState();
                    } else {
                        setUsernameErrorState('Username already taken.');
                        continueBtn.disabled = true;
                    }
                }, 300);
            });

            // Password input event listener
            passwordInput.addEventListener('input', () => {
                const password = passwordInput.value;

                const validation = validatePassword(password);
                if (!validation.isValid) {
                    setPasswordErrorState(validation.message);
                } else {
                    clearPasswordErrorState();
                }

                updateSignupButton();
            });

            continueBtn.addEventListener('click', () => {
                stepUsername.classList.add('hidden');
                stepCredentials.classList.remove('hidden');
                if (usernameConfirm) {
                    usernameConfirm.value = usernameInput.value.trim();
                    usernameConfirm.readOnly = true;
                }
                if (passwordInput) {
                    passwordInput.focus();
                }
                // Initially disable signup button since password is empty
                if (signupBtn) {
                    signupBtn.disabled = true;
                    signupBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                // If still on step 1, move to step 2 instead of submitting
                if (!stepCredentials || stepCredentials.classList.contains('hidden')) {
                    if (!continueBtn.disabled) {
                        stepUsername.classList.add('hidden');
                        stepCredentials.classList.remove('hidden');
                        if (usernameConfirm) {
                            usernameConfirm.value = usernameInput.value.trim();
                            usernameConfirm.readOnly = true;
                        }
                        if (passwordInput) {
                            passwordInput.focus();
                        }
                    }
                    return;
                }
                errorMsg.textContent = '';
                const username = usernameInput.value.trim();
                const password = passwordInput.value;

                // Validate password before submission
                const passwordValidation = validatePassword(password);
                if (!passwordValidation.isValid) {
                    setPasswordErrorState(passwordValidation.message);
                    passwordInput.focus();
                    return;
                }


                try {
                    const registerResponse = await fetch('/register/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({ username, password })
                    });

                    const regData = await registerResponse.json();

                    if (!registerResponse.ok) {
                        const usernameErr = regData.username?.[0];
                        const passwordErr = regData.password?.[0];
                        if (usernameErr) {
                            // back to step 1 for username error
                            stepCredentials.classList.add('hidden');
                            stepUsername.classList.remove('hidden');
                            setUsernameErrorState(usernameErr);
                            continueBtn.disabled = true;
                        } else if (passwordErr) {
                            setPasswordErrorState(passwordErr);
                        } else {
                            errorMsg.textContent = 'Registration failed: ' + JSON.stringify(regData);
                        }
                        return;
                    }


                    const loginResponse = await fetch('/api/auth/login/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({ username, password })
                    });

                    const loginData = await loginResponse.json();

                    if (loginResponse.ok) {
                        // Tokens are now stored securely in httpOnly cookies
                        // No need to handle them in JavaScript
                        window.location.href = '/';
                    } else {
                        errorMsg.textContent = 'Registered, but failed to log in: ' + JSON.stringify(loginData);
                    }
                } catch (err) {
                    console.error('Error during registration/login:', err);
                    errorMsg.textContent = 'An error occurred: ' + err.message;
                }
            });
</script>
</body>
</html>